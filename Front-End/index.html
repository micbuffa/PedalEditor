<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-store" />

    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <script src="./bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <script src="./bower_components/webaudio-controls/webaudio-controls.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script
        src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js">
    </script>
    <script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/sdk/WebAudioSDK.js"></script>

    <link rel="stylesheet" href="StyleSheet.css">
    <link rel="stylesheet" href="StyleSideNav.css">
    <link rel="stylesheet" href="index_css.css">
    <link rel="Stylesheet" href="SideBar.css">

    <link type="text/css" rel="stylesheet" href="rgbaColorPicker/rgbaColorPicker.css" />
    <script type="text/javascript" src="rgbaColorPicker/rgbaColorPicker.js"></script>

    <link rel="import" href="pedal_models/pedal.html">
    <link rel="import" href="editor-components/editor-pedal-details/editor-pedal-details.html">
    <link rel="import" href="editor-components/editor-element-list.html">
    <link rel="import" href="editor-components/editor-inspector.html">
    <link rel="import" href="editor-components/editor-faust/editor-faust.html">
    <link rel="import" href="editor-components/editor-pedal-new/editor-pedal-new-1.html">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->

    <!-- jQuery library -->

    <!-- Latest compiled JavaScript -->
    <!--<link rel="import" href="blue.html">
    <script src="jscolor.js"></script>-->

    <script src="pedal_models/functionalPedalGenerator.js"></script>

    <link
        href="https://fonts.googleapis.com/css?family=Abril+Fatface|Belgrano|Bevan|Bungee+Inline|Bungee+Shade|Calligraffitti|Mogra|Nothing+You+Could+Do|Orbitron|Pangolin|Rock+Salt|Sansita|Shojumaru|UnifrakturMaguntia|VT323"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <title>Pedal Creator 0.1</title>

</head>

<body>

    <!-- Pedal section -->
    <main class="pedalSection"></main>
    <div class="container"></div>

    <nav class="navbar navbar-expand navbar-dark bg-dark"> <a href="#menu-toggle" id="menu-toggle" class="navbar-brand"><span class="navbar-toggler-icon"></span></a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample02" aria-controls="navbarsExample02" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button>
        <div class="collapse navbar-collapse" id="navbarsExample02">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"> <a class="nav-link" href="#" ><i class="fa fa-trash"></i></a> </li>
                <li class="nav-item active"> <a class="nav-link" href="#" onclick="toggleFullScreen()"><i class="fa fa-arrows-alt"></i></a> </li>
                <li class="nav-item active"> <a class="nav-link" href="#"><i class="fa fa-download"></i></a> </li>
                <li class="nav-item active"> <a class="nav-link" href="#" onclick="savePedal()"><i class="fa fa-save"></i></a> </li>
                <li class="nav-item active"> <a class="nav-link" href="#" onclick="window.open('faust-editor','popUpWindow','height=500,width=400,left=100,top=100,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no, status=yes');"><i class="fa fa-pencil"></i></a> </li>
                <li class="nav-item active"> <a class="nav-link" data-toggle="modal" data-target="#myModal" href="#myModal"><i class="fa fa-plus-circle"></i></a></li>
                <!-- <li class="nav-item active"> <a class="nav-link" href="#" onclick="newPedal()"><i class="fa fa-plus-circle"></i></a> </li> -->
                <li class="nav-item active"> <a class="nav-link" href="#" onclick="window.location.reload();"><i class="fa fa-home"></i> <span class="sr-only">(current)</span></a> </li>
            </ul>
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"> <a class="nav-link" href="#"></a> </li>
                <li class="nav-item active"> <a class="nav-link" href="#"></a> </li>
            </ul>
            <form class="form-inline my-2 my-md-0"> </form>
        </div>
    </nav>

    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog" style="background-color: #333;">
      
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header" style="background-color: #333;">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title" style="color: blanchedalmond;">New Pedal</h4>
        </div>
        <div class="modal-body" style="background-color: #333;">
          <!-- <editor-pedal-new-1 width="400" height="400"></editor-pedal-new-1> -->
          <div class="form-group">
            <label class="col-sm-2 control-label" for="textinput" style="color: white;">Width</label>
            <div class="col-sm-10">
              <input type="text" placeholder="Width" id="width" class="form-control">
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label" for="textinput" style="color: white;">Color</label>
            <div class="col-sm-10">
              <input type="text" style="width: 100%;" placeholder="color" id="color" class="color" value="rgba(100,100,100,0.5)">
            </div>
          </div>
          <br>
          <div class="form-group">
            <label class="col-sm-2 control-label" for="textinput" style="color: white;">Height</label>
            <div class="col-sm-10">
              <input type="text" placeholder="Height" id="height" class="form-control">
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label" for="textinput" style="color: white;">Radius</label>
            <div class="col-sm-10">
              <input type="text" placeholder="Radius" id="radius" class="form-control">
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label" for="textinput" style="color: white;">Name</label>
            <div class="col-sm-10">
              <input type="text" placeholder="Name" id="name" class="form-control">
            </div>
          </div>

        </div>
        <div class="modal-footer" style="background-color: #333;">
            <div class="form-group">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <div class="pull-right">
                    <button type="submit" class="btn btn-default" style="color: black; background-color: white;" onclick="refreshModal()">Refresh</button>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="submit" class="btn btn-primary" onclick="newPedal()">Create</button>
                </div>
            </div>
        </div>
      </div>
      
        </div>
      </div>

    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <div id="accordion">
                    <div>
                            <details class="editor-collapsible">
        
                                    <summary><a href="#editor-pedal-details">Pedal configuration </a></summary>
                        
                                    <div class="editor-collapsible-content" >
                                            <editor-pedal-details id="editor-pedal-details" class="accordion"></editor-pedal-details>
                                    </div>
                            </details>   

                            <details class="editor-collapsible">
        
                                    <summary><a href="#editor-element-list">Elements </a></summary>
                        
                                    <div class="editor-collapsible-content" >
                                            <editor-element-list id="editor-element-list" class="accordion"></editor-element-list>
                                    </div>
                            </details>
                            
                            <details class="editor-collapsible">
        
                                    <summary><a href="#editor-inspector">Inspector </a></summary>
                        
                                    <div class="editor-collapsible-content" >
                                            <editor-inspector id="editor-inspector" class="accordion"></editor-inspector>
                                    </div>
                            </details>

                            <details class="editor-collapsible">
        
                                    <summary><a href="#editor-faust">Faust </a></summary>
                        
                                    <div class="editor-collapsible-content" >
                                            <editor-faust id="editor-faust" class="accordion"></editor-faust>
                                    </div>
                            </details>
                    </div>
                    
                </div>
            </div>
                    
            </ul>
        </div> 

        <!-- /#sidebar-wrapper -->
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                
            </div>
        </div> <!-- /#page-content-wrapper -->
    </div>




</body>
<script>

$('a[href$="#myModal"]').on( "click", function() {
   $('#myModal').modal('show');
});



$(function(){
            $("#menu-toggle").click(function(e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });

            $(window).resize(function(e) {
              if($(window).width()<=768){
                $("#wrapper").removeClass("toggled");
              }else{
                $("#wrapper").addClass("toggled");
              }
            });
          });


function toggleFullScreen() {
  if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen(); 
    }
  }
}

function RGBAToHexA(r,g,b,a) {
  r = r.toString(16);
  g = g.toString(16);
  b = b.toString(16);
  a = Math.round(a * 255).toString(16);

  if (r.length == 1)
    r = "0" + r;
  if (g.length == 1)
    g = "0" + g;
  if (b.length == 1)
    b = "0" + b;
  if (a.length == 1)
    a = "0" + a;

  return "#" + r + g + b + a;
}


function refreshModal(){
    
    document.getElementById('width').value = '';
    document.getElementById('color').value = '';
    document.getElementById('height').value = '';
    document.getElementById('radius').value = '';
    document.getElementById('name').value = '';
}

    var url = "http://localhost:8085";
    let serverUrl = 'http://localhost:3000';

    var http = new XMLHttpRequest();
    var path = "/pedale";
    //var ctx = new AudioContext();
    var section = document.getElementsByClassName("pedalSection")[0];
    var pedal = getFirstChild(section);
    var knobSprite;
    var switchSprite;
    let savedPedalsConfigs;
    let functionalPedalGenerator;

    var bt_buildIt = document.querySelector('#bt_buildIt');
    let currentWapName;


    window.onload = initialize;

    function initialize() {
        var urlParams = new URLSearchParams(window.location.search);

        console.log(urlParams.has('data')); // true
        console.log(urlParams.get('data'));
        console.log("name present : " + urlParams.has('name')); // true
        console.log("name = " + urlParams.get('name'));
        console.log("### FAUSTUI JSON = ");
        console.log(urlParams.get('data'));
        console.log("###")
        faustUI = JSON.parse(urlParams.get('data'));
        let name = urlParams.get('name');
        /* faustUI.WapName = name.substr(0, name.lastIndexOf("."));
        document.querySelector("#wapName").innerHTML = faustUI.WapName; */

        console.log("Initialize")
        console.log("faustUI = ", faustUI)
        //setFaustUIFromUrl();
        //console.log("faustUi aprÃ¨s setFaustUIFromUrl= ", faustUI)


        //displaySavedPedalsIds();

        /* bt_buildIt.addEventListener('click', () => {

            checkMetadata(document.querySelector("#urlPlugin").value);
        }); */

        let faust = document.querySelector('#editor-faust'),
            faustClone = faust.cloneNode(true);
        faust.parentNode.replaceChild(faustClone, faust);

        faust = document.querySelector('#editor-faust');
        /*faust.addEventListener('create-pedal', (e) => {
            newPedal();
            let pedalConfig = {
                name: "First",
                color: "#7caeff",
                width: e.detail.width,
                height: e.detail.height,
                radius: "10",
                opacity: "1",
                elements: e.detail.elements
            };
            //console.log(e.detail);
            pedal.loadConfig(pedalConfig);
        });*/
        if (window.faustUI) {
            console.log("### faustUI present ! ####")
            console.log(window.faustUI);
            newPedal(null, true);

            let detail = faust.pedalConfigFromUI(window.faustUI);

            let pedalConfig = {
                name: window.faustUI.WapName,
                color: "#7caeff",
                width: detail.width,
                height: detail.height,
                radius: "10",
                opacity: "1",
                elements: detail.elements
            };
            console.log(detail);
            console.log("PEDALCONFIG = ", pedalConfig);

            pedal.loadConfig(pedalConfig);
            currentWapName = pedalConfig.name;

        }
    }

    function setFaustUIFromUrl() {
        let url = new URL(location);
        let searchParams = new URLSearchParams(url.search);
        console.log("url = ", url)
        faustUI = searchParams.get('data');
        console.log("data = ", faustUI)
    }


    /*Slider Nav Menu*/
    function openNav() {
        document.getElementById("mySidenav").style.width = "500px";
    }

    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
    }

    function newPedal(args, withoutInit) {



        section.innerHTML = '';
        pedal = null;
        let pedalElem = document.createElement('my-pedal');
        section.appendChild(pedalElem);
        pedal = pedalElem;

        pedal.addEventListener('select-knob', function (e) {
            selectKnob(e.detail);
            updateInspector();
        });

        if (!withoutInit) {
            initialize();
        }

        var r = Number(document.getElementById("color").value.slice(5,8));
        var g = Number(document.getElementById("color").value.slice(9,12));
        var b = Number(document.getElementById("color").value.slice(13,16));
        var a = Number(document.getElementById("color").value.slice(17,20));


        let defaultPedalConfig = {
            color: RGBAToHexA(r,g,b,a),
            width: document.getElementById('width').value,
            height: document.getElementById('height').value,
            radius: document.getElementById('radius').value,
            elements: [],
            name: document.getElementById('name').value
        };

        if (args) {
            defaultPedalConfig.name = args.name;
            defaultPedalConfig.height = args.height;
            defaultPedalConfig.width = args.width;
            defaultPedalConfig.name = args.name;
            defaultPedalConfig.elements = args.elements;
        }

        pedal.loadConfig(defaultPedalConfig);

        plugPedalToEditor();



        functionalPedalGenerator = new FunctionalPedalGenerator(pedal);;
    }

    function savePedal() {

        let pedalName = pedal.getAttribute('name');
        if (pedalName == '') {
            alert('You should enter the pedal name before saving !');
            return;
        }

        let config = pedal.getConfig();

        let http = new XMLHttpRequest();
        let url = serverUrl + '/pedals';
        let params = config;
        http.open("POST", url, true);

        http.setRequestHeader("Content-type", "application/json");

        http.onreadystatechange = function () {
            if (http.readyState == 4 && http.status == 200) {
                alert('Saved successfully!');
                pedal.pedalId = JSON.parse(http.responseText).id;
                //displaySavedPedalsIds();
            }
        }
        http.send(JSON.stringify(params));
        generateCodeFunctionalPedalFetch();
    }

    function refreshSavedPedalsConfigs() {
        let request = new XMLHttpRequest();
        request.open('GET', serverUrl + '/pedals', false);
        request.send(null);
        let pedalConfigs = JSON.parse(request.responseText);
        savedPedalsConfigs = pedalConfigs;
    }

   /*  function displaySavedPedalsIds() {

        // Uptates the list of pedal configurations by fetching then from the server. 
        refreshSavedPedalsConfigs();

        // Gets the select element that displays the list of names of the saved pedal configurations. 
        let loadPedalElem = document.querySelector('#load-pedal');

        let oldVal = loadPedalElem.value;

        // Flushes the select element to get rid of the old pedal configurations that have been generated
        //during the last call to this function. If we don't flush it, the names of the new pedal configurations
        //will be appended to the ones that has been fetched in the previous call to the function.
        loadPedalElem.innerHTML = '';

        for (let savedPedalConfig of savedPedalsConfigs) {
            let savedPedalIdElem = document.createElement('option');
            savedPedalIdElem.setAttribute('value', savedPedalConfig.id);
            savedPedalIdElem.innerHTML = savedPedalConfig.name;

            loadPedalElem.appendChild(savedPedalIdElem);
        }

        loadPedalElem.value = oldVal;

    } */


    function setSelectedElementLabel(value) {
        let element = pedal.getSelectedElement();
        element.label = value;
        pedal.updateStyle_();
    }

    function setSelectedElementLabelColor(value) {
        let element = pedal.getSelectedElement();
        element.label_color = value;
        pedal.updateStyle_();
    }

    function setSelectedElementLabelFontfamily(value) {
        let element = pedal.getSelectedElement();
        element.label_fontfamily = value;
        pedal.updateStyle_();
    }

    function setSelectedElementLabelFontsize(value) {
        let element = pedal.getSelectedElement();
        element.label_fontsize = value;
        pedal.updateStyle_();
    }

    function setSelectedElementValue(value) {
        let element = pedal.getSelectedElement();
        element.value = value;
        pedal.updateStyle_();
    }

    function setSelectedElementModel(value) {
        let element = pedal.getSelectedElement();
        element.model = value;
        pedal.updateStyle_();
        selectKnob(pedal.getSelectedElement());
    }

    function setSelectedElementXPosition(xPosition) {
        let element = pedal.getSelectedElement();
        element.x = xPosition;
        pedal.updateStyle_();
    }

    function setSelectedElementYPosition(yPosition) {
        let element = pedal.getSelectedElement();
        element.y = yPosition;
        pedal.updateStyle_();
    }

    function setSelectedElementWidth(width) {
        let keepRatio = document.querySelector("#keep-ratio").checked;


        let element = pedal.getSelectedElement();
        element.width = width;

        if (keepRatio) {
            element.height = element.width;
            document.querySelector("#inspector-height").value = width;
        }

        pedal.updateStyle_();
    }

    function setSelectedElementHeight(height) {
        let keepRatio = document.querySelector("#keep-ratio").checked;

        let element = pedal.getSelectedElement();
        element.height = height;

        if (keepRatio) {
            element.width = element.height;
            document.querySelector("#inspector-width").value = height;

        }

        pedal.updateStyle_();
    }

    /*function updatePedalElementsSection() {

        // Deleting the elements of all the sections.
        for (let pedalElementType of pedal.getElementsTypes()) {
            let section = getSectionByPedalElementType(pedalElementType);

            if (!section) {
                continue;
            }

            let firstChild;
            while (firstChild = section.firstChild) {
                section.removeChild(firstChild);
            }
        }


        // Populating the sections.
        for (let pedalElement of pedal.getElements()) {
            let section = getSectionByPedalElementType(pedalElement.type);
            if (!section) {
                continue;
            }

            let idElem = document.createElement('div');
            idElem.className = pedalElement.type + '_id';
            idElem.innerHTML = pedalElement.id;
            idElem.onclick = (e) => {
                selectKnob(e.target.innerHTML);
            }

            section.appendChild(idElem);
        }

        // Select the pedal's selected element.
        let selectedElement = pedal.getSelectedElement();
        if (selectedElement) {
            selectKnob(selectedElement.id);
        }

    }*/

    function getSectionByPedalElementType(pedalElementType) {
        let section = document.querySelector('#' + pedalElementType + '_section');

        return section;
    }

    function updateInspector() {
        pedal.getSelectedElement();
    }

    function selectKnob(knobId) {

        /*
        var knobs = document.getElementById('knob_section').childNodes;
        var icons = document.getElementById('icon_section').childNodes;

        for (let knob of knobs) {
            // TODO: Remove.
            if (knob.className)
                knob.className = knob.className.replace('selected', '');
            if (knob.innerHTML === knobId) {
                knob.className += ' selected';
            }
        }

        for (let icon of icons) {
            // TODO: Remove.
            if (icon.className)
                icon.className = icon.className.replace('selected', '');
            if (icon.innerHTML === knobId) {
                icon.className += ' selected';
            }
        }

        if (pedal.getSelectedElement().id != knobId) {
            pedal.selectElement(knobId);
        }*/


        let knob = pedal.getSelectedElement();
        let inspectorId = document.getElementById('inspector-id');
        let inspectorLabel = document.getElementById('inspector-label');
        let inspectorLabelColor = document.getElementById('inspector-label-color');
        let inspectorLabelFontFamily = document.getElementById('inspector-label-font-family');
        let inspectorLabelSize = document.getElementById('inspector-label-font-size');
        let inspectorXPosition = document.getElementById('inspector-x-position');
        let inspectorYPosition = document.getElementById('inspector-y-position');
        let inspectorWidth = document.getElementById('inspector-width');
        let inspectorHeight = document.getElementById('inspector-height');

        let inspectorModel = document.getElementById('inspector-model');
        let inspectorPreview = document.getElementById('inspector-preview');



        inspectorLabel.value = knob.label;
        inspectorLabelColor.value = knob.label_color;
        inspectorLabelFontFamily.value = knob.label_fontfamily;
        inspectorLabelSize.value = knob.label_fontsize;
        inspectorXPosition.value = knob.x;
        inspectorYPosition.value = knob.y;
        inspectorWidth.value = knob.width || 0;
        inspectorHeight.value = knob.height || 0;

        inspectorModel.value = knob.model;

        let inspector = document.getElementById('inspector');
    }

    function deleteSelectedElement() {
        pedal.deleteSelectedElement();
        updatePedalElementsSection();
    }

    function addSlider() {
        pedal.addElement('slider');
    }



    function loadPedalConfig(value) {

        newPedal();
        for (let pedalConfig of savedPedalsConfigs) {
            if (pedalConfig.id == value) {
                pedal.loadConfig(pedalConfig);

                let loadPedal = document.querySelector('#load-pedal');
                loadPedal.value = value;
            }
        }

        plugPedalToEditor();
    }

    function plugPedalToEditor() {

        // Plug pedal to pedal details component
        let pedalDetails = document.querySelector('#editor-pedal-details');
        let newPedalDetails = pedalDetails.cloneNode();
        pedalDetails.parentNode.replaceChild(newPedalDetails, pedalDetails);
        newPedalDetails.setEditablePedal(pedal);

        // Plug pedal to element list component
        let elementList = document.querySelector('#editor-element-list');
        elementList.setEditablePedal(pedal);

        // Plug pedal to inspector component
        let inspector = document.querySelector('#editor-inspector');
        inspector.setEditablePedal(pedal);
    }

    function getFirstChild(el) {
        var firstChild = el.firstChild;

        while (firstChild != null && firstChild.nodeType == 3) { // skip TextNodes
            firstChild = firstChild.nextSibling;
        }

        return firstChild;
    }

    // Sends the main.html GUI file for the wap named currentWapName
    // to the backend server. A dir is created if there is none already
    // created for this WAP.
    // It also copies asset files if necessary, and finally sends a message to the Faust IDE
    // to ask for it to generate a binary.zip file with the DSP code. An async message will be 
    // sent back by the faust IDE when ready (processed in the next listener defined after this
    // function)
    function generateCodeFunctionalPedalFetch() {
        let url = serverUrl + '/generate';

        let data = new FormData();
        data.append("generated", functionalPedalGenerator.generateFunctionalPedalCode());
        data.append("wapName", currentWapName);

        fetch(url, {
                method: "POST",
                body: data
            })
            .then((responseJSON) => {
                responseJSON.json()
                    .then(res => {
                        console.log(res.message);
                        alert(res.message);
                    })
            })
            .catch(err => {
                console.log(err)
            })

        // 1 - SEND ASYNC MESSAGE TO FAUST EDITOR
        console.log("SENDING EXPORT MESSAGE TO FAUST EDITOR")
        if (window.parent !== window) {
            window.parent.postMessage({
                type: "export",
                plat: "web",
                arch: "wap"
            })
        }

    }

    // 2 - SENT BY FAUST IDE WHEN THE BINARY.ZIP FILE IS READY TO BE SENT TO BACK-END WAP SERVER
    window.addEventListener("message", (e) => {
        const data = e.data;
        if (data.type === "exported") {
            let wapBinaryDotZipFileURL = data.href
            console.log(wapBinaryDotZipFileURL);

            // Let's send a message to the backend server so that it gets
            // this file, and unzip it in the same dir the main.html GUI file + assets
            // have been created
            let url = serverUrl + '/addBinaryDotZip';
            let data2 = new FormData();
            data2.append("url", wapBinaryDotZipFileURL);
            data2.append("wapName", currentWapName);

            fetch(url, {
                    method: "POST",
                    body: data2
                })
                .then((responseJSON) => {
                    responseJSON.json()
                        .then(res => {
                            console.log(res.message);
                            alert(res.message);
                        })
                })
                .catch(err => {
                    console.log(err)
                })
        }
    });


    // Sends the binary.zip to the Back-End
    function publish(downPath, pedalName) {
        var http = new XMLHttpRequest();
        var url = 'http://localhost:3000/generated-wap';
        var params = {
            url: downPath,
            pedalName: "current"
        };

        http.open('POST', url, true);

        //Send the proper header information along with the request
        http.setRequestHeader('Content-type', "application/json");

        http.onreadystatechange = function () { //Call a function when the state changes.
            if (http.readyState == 4 && http.status == 200) {
                alert(http.responseText);
            }
        }

        http.send(JSON.stringify(params));
    }

    function toggleHidden(elem) {
        if (elem.style.display === 'none') {
            elem.style.display = 'block';
        } else {
            elem.style.display = 'none';
        }
    }

    function toggleEditorPedalDetails() {
        let elem = document.querySelector('#editor-pedal-details');
        toggleHidden(elem);
    }



    // And of the forked content
    // -----------------------------Json fetching part ---------------------------//

    function checkMetadata(baseURL) {
        fetch(baseURL + "/main.json").then(responseJSON => {
            return responseJSON.json();
        }).then(metadata => {
            let name = metadata.name
            let className = metadata.vendor + metadata.name;
            loadPlugin(className, name, baseURL);
        }).catch((e) => {
            console.log(e);
        });
    }

    // add the script tag and load the plugin 
    function loadPlugin(className, name, baseURL) {
        let scriptURL = baseURL + "/main.js";

        // if we are here this means that the script is not present. Add it to the document
        let script = document.createElement("script");
        script.src = scriptURL;

        script.onload = function () {
            // Once the script has been loaded instanciate the plugin
            getDescriptorFromPlugin(className, name, baseURL);
        }
        // will be executed before the onload above...
        document.head.appendChild(script);
    }

    // instanciate the plugin 
    /* function getDescriptorFromPlugin(className, name, baseURL) {

         var plugin = new window[className](ctx, baseURL);
         console.log(plugin);

         plugin.load().then((node) => {
             plugin.loadGui().then((elem) => {
                 let descriptor = node.getDescriptor();
                 let dimensions = elem.properties;
                 let nbParam = Object.keys(descriptor).length;
                 var count = 0;
                 let hoffset = 50;
                 let voffset = 60;
                 console.log(descriptor);

                 //--------------------------------- JSON edition PART -------------------------//
                 let extendedDescriptor = {
                     "name": name,
                     "backgroundImageSrc": "image2.png",
                     "color": "#AB2E24",
                     "width": dimensions.dataWidth.value,
                     "height": dimensions.dataHeight.value,
                     "radius": "10",
                     "elements": []
                 }


                 for (var param in descriptor) {
                     // 2* because we want by default two ranges of knobs
                     let horizontalRange = Math.ceil(count % (nbParam / 2));
                     let verticalRange = Math.floor(count / (nbParam / 2));
                     console.log(param, horizontalRange, verticalRange);

                     // Here we do a little normalisation because we have to select by ID later

                     if (descriptor.hasOwnProperty(param)) {
                         var element = {
                             "id": param.toLowerCase().replace(/ /g, "").replace('\/', ""),
                             "x": hoffset * horizontalRange,
                             "y": voffset * verticalRange,
                             "width": 40,
                             "height": 40,
                             "model": "Carbon.png",
                             "value": descriptor[param].defaultValue,
                             "min": descriptor[param].minValue,
                             "max": descriptor[param].maxValue,
                             "label": param,
                             "label_fontfamily": "Verdana",
                             "label_fontsize": "7",
                             "label_color": "000000",
                             "type": "knob"
                         }

                     }
                     count++;
                     extendedDescriptor.elements.push(element);


                 }
                 var elemlabel = {
                     "x": 20,
                     "y": 130,
                     "label": name,
                     "label_fontfamily": 'Comic Sans MS',
                     "label_fontsize": '14',
                     "label_color": 'ffffff',
                     "type": 'label'
                 }
                 extendedDescriptor.elements.push(elemlabel);
                 //-------------------- END of JSON Edition -------------------- //

                 newPedal(extendedDescriptor);
                 console.log(extendedDescriptor);


             });
             delete node;

         });

         delete plugin;

     }*/
</script>

</html>